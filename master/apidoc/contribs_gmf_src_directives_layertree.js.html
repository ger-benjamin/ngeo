<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: contribs/gmf/src/directives/layertree.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: contribs/gmf/src/directives/layertree.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>goog.provide('gmf.LayertreeController');
goog.provide('gmf.layertreeDirective');

goog.require('gmf');
goog.require('ngeo.LayerHelper');
goog.require('ngeo.LayertreeController');
goog.require('ngeo.layertreeDirective');
goog.require('ol.Collection');
goog.require('ol.layer.Group');
goog.require('ol.layer.Image');
goog.require('ol.layer.Tile');
goog.require('ol.source.ImageWMS');


gmfModule.value('gmfLayertreeTemplate',
    /**
     * @param {angular.JQLite} element Element.
     * @param {angular.Attributes} attrs Attributes.
     */
    function(element, attrs) {
      var subTemplateUrl = gmf.baseTemplateUrl + '/layertree.html';
      return '&lt;div ngeo-layertree="gmfLayertreeCtrl.tree" ' +
          'ngeo-layertree-map="gmfLayertreeCtrl.map" ' +
          'ngeo-layertree-nodelayer="gmfLayertreeCtrl.getLayer(node)" ' +
          'ngeo-layertree-templateurl="' + subTemplateUrl + '"' +
          '&lt;/div>';
    });


/**
 * This directive creates a layertree based on a c2cgeoportal JSON themes source
 * and a ngeo.Layertree. The default used template can be overrided by setting
 * the constant 'gmf.layertreeTemplate'. The controller used by this
 * directive defines some fonctions for each node that are created by a default
 * template. This default template can be overrided by setting the constant
 * 'gmf.layertreeTemplateUrl'.
 *
 * @example
 * &lt;gmf-layertree
 *   gmf-layertree-themes="ctrl.themes"
 *   gmf-layertree-map="ctrl.map"
 *   gmf-layertree-wmsurl="ctrl.wmsUrl"
 *   gmf-layertree-templateurl="path/to/layertree.html">
 * &lt;/gmf-layertree>
 *
 * @param {string|function(!angular.JQLite=, !angular.Attributes=)}
 *     gmfLayertreeTemplate Template for the directive.
 * @return {angular.Directive} The directive specs.
 * @ngInject
 * @ngdoc directive
 * @ngname gmfLayertreeDirective
 */
gmf.layertreeDirective = function(gmfLayertreeTemplate) {
  return {
    scope: {
      'getMapFn': '&amp;gmfLayertreeMap',
      'getWmsUrlFn': '&amp;gmfLayertreeWmsurl',
      'themes': '=gmfLayertreeThemes'
    },
    controller: 'GmfLayertreeController',
    controllerAs: 'gmfLayertreeCtrl',
    template: gmfLayertreeTemplate
  };
};

gmfModule.directive('gmfLayertree', gmf.layertreeDirective);



/**
 * @param {angular.Scope} $scope The directive's scope.
 * @param {ngeo.LayerHelper} ngeoLayerHelper Ngeo Layer Helper.
 * @constructor
 * @export
 * @ngInject
 * @ngdoc controller
 * @ngname gmfLayertreeController
 */
gmf.LayertreeController = function($scope, ngeoLayerHelper) {

  var map = $scope['getMapFn']();
  goog.asserts.assertInstanceof(map, ol.Map);

  /**
   * @type {!ol.Map}
   * @export
   */
  this.map = map;

  /**
   * @type {string}
   * @export
   */
  this.nodeTemplateUrl = gmf.baseTemplateUrl + '/layertree.html';

  var wmsUrl = $scope['getWmsUrlFn']();
  goog.asserts.assert(goog.isString(wmsUrl));

  /**
   * @type {string}
   * @private
   */
  this.wmsUrl_ = wmsUrl;

  /**
   * @type {ngeo.LayerHelper}
   * @private
   */
  this.layerHelper_ = ngeoLayerHelper;
  this.layerHelper_.init(this.map);

  //FIXME Choose a theme in gmf datasource
  $scope.$watch('themes', goog.bind(function(newVal) {
    if (goog.isDef(newVal)) {
      var themes = newVal['themes'];
      if (goog.isDef(themes)) {
        this['tree'] = themes[3];
      }
    }
  }, this));
};


/**
 * Create and return a layer corresponding to the ngeo.layerTree's node.
 * Can currently only creates WMS layers (internal or external) and WMTS layers.
 * @param {GmfThemesNode} node Layer tree node.
 * @return {ol.layer.Layer} The OpenLayers layer or group for the node.
 * @export
 */
gmf.LayertreeController.prototype.getLayer = function(node) {
  var wmsUrl = this.wmsUrl_;
  var layerHelper = this.layerHelper_;

  var makeLayers = function(node) {
    var i, children = node.children;
    var layers = new ol.Collection();
    if (goog.isDef(children)) {
      for (i = 0; i &lt; children.length; i++) {
        layers.push(makeLayers(children[i]));
      }
      return layerHelper.createBasicGroup(layers);
    }

    if (node.type === 'WMTS') {
      var layerWithoutSource = new ol.layer.Tile();
      var promise = layerHelper.createWMTSLayerFromCapabilitites(node.url,
          node.name);
      promise.then(function(layer) {
        if (goog.isDef(layer)) {
          layerWithoutSource.setSource(layer.getSource());
        }
      });
      return layerWithoutSource;

    } else if (node.type === 'external WMS') {
      return layerHelper.createBasicWMSLayer(node.url, node.name);

    } else {
      return layerHelper.createBasicWMSLayer(wmsUrl, node.name);
    }
  };

  return makeLayers(node);
};


/**
 * Return a 'light' class if the current resolution of the map is out of
 * the  min/max resolution in the node.
 * @param {GmfThemesNode} node Layer tree node.
 * @return {?string} 'light' or null.
 * @export
 */
gmf.LayertreeController.prototype.getResolutionStyle = function(node) {
  var style;
  var resolution = this.map.getView().getResolution();
  var maxExtent = node['maxResolutionHint'];
  var minExtent = node['minResolutionHint'];
  if (goog.isDef(minExtent) &amp;&amp; resolution &lt; minExtent ||
      goog.isDef(maxExtent) &amp;&amp; resolution > maxExtent) {
    style = 'light';
  }
  return style || null;
};


/**
 * Toggle activation of a node by adding or removing relative(s) layer(s) on
 * the map.
 * @param {ngeo.LayertreeController} treeCtrl Layer tree controller, from the
 *     current node.
 * @export
 */
gmf.LayertreeController.prototype.toggleActive = function(treeCtrl) {
  var layer = treeCtrl.scope['layer'];
  // Check if the current node state is 'activated'.
  var add = (this.getSetActive(treeCtrl) === 'on') ? false : true;
  // Add/remove layers
  var layers = this.layerHelper_.getFlatLayers(layer);
  this.layerHelper_.moveInOutLayers(layers, add);
};


/**
 * Return a class name that match with the current node activation state.
 * @param {ngeo.LayertreeController} treeCtrl Layer tree controller, from the
 *     current node.
 * @return {string} The name of de class to apply (on/off/indeterminate).
 * @export
 */
gmf.LayertreeController.prototype.getSetActive = function(treeCtrl) {
  var style;
  var node = treeCtrl.node;
  var layer = treeCtrl.scope['layer'];

  if (goog.isDef(node.children)) {
    // Find number of actives layers on the map from this layer group.
    var i, nbrLayerOnMap = 0;
    var layers = this.layerHelper_.getFlatLayers(layer);
    for (i = 0; i &lt; layers.length; i++) {
      if (this.layerHelper_.getLayerIndex(layers[i]) >= 0) {
        nbrLayerOnMap++;
      }
    }
    // Get style for this layer group node state
    if (nbrLayerOnMap === layers.length) {
      style = 'on';
    } else if (nbrLayerOnMap > 0) {
      style = 'indeterminate';
    } else {
      style = 'off';
    }
  } else {
    // Get style of this node depending if the corresponding layer is on
    // the map.
    style = (this.layerHelper_.getLayerIndex(layer) >= 0) ? 'on' : 'off';
  }
  return style;
};


/**
 * Return "noSource" if no source is defined in the given treeCtrl's layer.
 * @param {ngeo.LayertreeController} treeCtrl Layer tree controller, from the
 *     current node.
 * @return {?string}
 * @export
 */
gmf.LayertreeController.prototype.getNoSourceStyle = function(treeCtrl) {
  var layer = treeCtrl.scope['layer'];
  if (goog.isDef(layer.getSource)) {
    if (!goog.isDefAndNotNull(layer.getSource())) {
      return 'no-source';
    }
  }
  return null;
};


/**
 * Set the resolution of the map with node max or min resolution.
 * @param {GmfThemesNode} node Layer tree node.
 * @export
 */
gmf.LayertreeController.prototype.zoomToResolution = function(node) {
  var view = this.map.getView();
  var extent = node['maxResolutionHint'] || node['minResolutionHint'];
  if (goog.isDef(extent)) {
    view.setResolution(extent);
  }
};


gmfModule.controller('GmfLayertreeController', gmf.LayertreeController);
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h2>gmf</h2><h3>Directives</h3><ul><li><a href="gmf.layertreeDirective.html">layertreeDirective</a></li><li><a href="gmf.locationchooserDirective.html">locationchooserDirective</a></li><li><a href="gmf.mapDirective.html">mapDirective</a></li><li><a href="gmf.searchDirective.html">searchDirective</a></li></ul><h3>Services</h3><ul><li><a href="gmf.Themes.html">Themes</a></li></ul><h3>Controllers</h3><ul><li><a href="gmf.LayertreeController.html">LayertreeController</a></li><li><a href="gmf.LocationchooserController.html">LocationchooserController</a></li><li><a href="gmf.MapController.html">MapController</a></li><li><a href="gmf.SearchController.html">SearchController</a></li></ul><h3>Classes</h3><ul><li><a href="gmf.AbstractMobileController.html">AbstractMobileController</a></li></ul><h3>Types</h3><ul><li><a href="gmf.html#ExportFeatures">ExportFeatures</a></li><li><a href="gmf.html#ThemesResponse">ThemesResponse</a></li></ul><h3>Enumerations</h3><ul><li><a href="gmf.html#ExportFormat">ExportFormat</a></li><li><a href="gmf.html#ThemesEventType">ThemesEventType</a></li></ul><h2>gmf.source</h2><h3>Classes</h3><ul><li><a href="gmf.source.AsitVD.html">AsitVD</a></li><li><a href="gmf.source.Swisstopo.html">Swisstopo</a></li></ul><h2>ngeo</h2><h3>Directives</h3><ul><li><a href="ngeo.btnDirective.html">btnDirective</a></li><li><a href="ngeo.btngroupDirective.html">btngroupDirective</a></li><li><a href="ngeo.controlDirective.html">controlDirective</a></li><li><a href="ngeo.desktopGeolocationDirective.html">desktopGeolocationDirective</a></li><li><a href="ngeo.filereaderDirective.html">filereaderDirective</a></li><li><a href="ngeo.layertreeDirective.html">layertreeDirective</a></li><li><a href="ngeo.mapDirective.html">mapDirective</a></li><li><a href="ngeo.mobileGeolocationDirective.html">mobileGeolocationDirective</a></li><li><a href="ngeo.modalDirective.html">modalDirective</a></li><li><a href="ngeo.popupDirective.html">popupDirective</a></li><li><a href="ngeo.profileDirective.html">profileDirective</a></li><li><a href="ngeo.recenterDirective.html">recenterDirective</a></li><li><a href="ngeo.resizemapDirective.html">resizemapDirective</a></li><li><a href="ngeo.scaleselectorDirective.html">scaleselectorDirective</a></li><li><a href="ngeo.searchDirective.html">searchDirective</a></li><li><a href="ngeo.sortableDirective.html">sortableDirective</a></li></ul><h3>Services</h3><ul><li><a href="ngeo.BackgroundLayerMgr.html">BackgroundLayerMgr</a></li><li><a href="ngeo.CreateGeoJSONBloodhound.html">CreateGeoJSONBloodhound</a></li><li><a href="ngeo.createPrintServiceFactory.html">createPrintServiceFactory</a></li><li><a href="ngeo.Debounce.html">Debounce</a></li><li><a href="ngeo.DecorateGeolocation.html">DecorateGeolocation</a></li><li><a href="ngeo.DecorateInteraction.html">DecorateInteraction</a></li><li><a href="ngeo.DecorateLayer.html">DecorateLayer</a></li><li><a href="ngeo.FeatureOverlayMgr.html">FeatureOverlayMgr</a></li><li><a href="ngeo.getBrowserLanguageFactory.html">getBrowserLanguageFactory</a></li><li><a href="ngeo.LayerHelper.html">LayerHelper</a></li><li><a href="ngeo.Location.html">Location</a></li><li><a href="ngeo.Popup.html">Popup</a></li><li><a href="ngeo.PrintUtils.html">PrintUtils</a></li><li><a href="ngeo.SyncArrays.html">SyncArrays</a></li><li><a href="ngeo.ToolActivateMgr.html">ToolActivateMgr</a></li></ul><h3>Controllers</h3><ul><li><a href="ngeo.BtnGroupController.html">BtnGroupController</a></li><li><a href="ngeo.DesktopGeolocationController.html">DesktopGeolocationController</a></li><li><a href="ngeo.LayertreeController.html">LayertreeController</a></li><li><a href="ngeo.MobileGeolocationController.html">MobileGeolocationController</a></li><li><a href="ngeo.ScaleselectorController.html">ScaleselectorController</a></li></ul><h3>Classes</h3><ul><li><a href="ngeo.BackgroundEvent.html">BackgroundEvent</a></li><li><a href="ngeo.FeatureOverlay.html">FeatureOverlay</a></li><li><a href="ngeo.MeasureEvent.html">MeasureEvent</a></li><li><a href="ngeo.Print.html">Print</a></li><li><a href="ngeo.profile.html">profile</a></li><li><a href="ngeo.ToolActivate.html">ToolActivate</a></li></ul><h3>Types</h3><ul><li><a href="ngeo.html#CreatePopup">CreatePopup</a></li><li><a href="ngeo.html#CreatePrint">CreatePrint</a></li><li><a href="ngeo.html#FeatureOverlayGroup">FeatureOverlayGroup</a></li><li><a href="ngeo.html#GetBrowserLanguage">GetBrowserLanguage</a></li><li><a href="ngeo.html#MockLocationProvider">MockLocationProvider</a></li><li><a href="ngeo.html#ScaleselectorOptions">ScaleselectorOptions</a></li><li><a href="ngeo.html#SortableOptions">SortableOptions</a></li></ul><h3>Enumerations</h3><ul><li><a href="ngeo.html#BackgroundEventType">BackgroundEventType</a></li><li><a href="ngeo.html#MeasureEventType">MeasureEventType</a></li><li><a href="ngeo.html#PrintStyleType">PrintStyleType</a></li></ul><h2>ngeo.format</h2><h3>Classes</h3><ul><li><a href="ngeo.format.FeatureHash.html">FeatureHash</a></li></ul><h3>Enumerations</h3><ul><li><a href="ngeo.format.html#FeatureHashStyleType">FeatureHashStyleType</a></li></ul><h2>ngeo.interaction</h2><h3>Classes</h3><ul><li><a href="ngeo.interaction.DrawAzimut.html">DrawAzimut</a></li><li><a href="ngeo.interaction.Measure.html">Measure</a></li><li><a href="ngeo.interaction.MeasureArea.html">MeasureArea</a></li><li><a href="ngeo.interaction.MeasureAzimut.html">MeasureAzimut</a></li><li><a href="ngeo.interaction.MeasureLength.html">MeasureLength</a></li></ul><h3>Types</h3><ul><li><a href="ngeo.interaction.html#MeasureBaseOptions">MeasureBaseOptions</a></li></ul><h2>ngeo.MeasureEvent</h2><h3>Events</h3><ul><li><a href="ngeo.MeasureEvent.html#event:measureend">measureend</a></li></ul><h2>ngeox</h2><h3>Interfaces</h3><ul><li><a href="ngeox.BackgroundEvent.html">BackgroundEvent</a></li><li><a href="ngeox.MeasureEvent.html">MeasureEvent</a></li></ul><h3>Types</h3><ul><li><a href="ngeox.html#DesktopGeolocationDirectiveOptions">DesktopGeolocationDirectiveOptions</a></li><li><a href="ngeox.html#MobileGeolocationDirectiveOptions">MobileGeolocationDirectiveOptions</a></li><li><a href="ngeox.html#SearchDirectiveListeners">SearchDirectiveListeners</a></li></ul><h2>ngeox.format</h2><h3>Types</h3><ul><li><a href="ngeox.format.html#FeatureHashOptions">FeatureHashOptions</a></li></ul><h2>ngeox.interaction</h2><h3>Types</h3><ul><li><a href="ngeox.interaction.html#MeasureOptions">MeasureOptions</a></li></ul><h2>ngeox.profile</h2><h3>Types</h3><ul><li><a href="ngeox.profile.html#ElevationExtractor">ElevationExtractor</a></li><li><a href="ngeox.profile.html#PoiExtractor">PoiExtractor</a></li><li><a href="ngeox.profile.html#ProfileFormatter">ProfileFormatter</a></li><li><a href="ngeox.profile.html#ProfileOptions">ProfileOptions</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
