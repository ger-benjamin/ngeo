<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: contribs/gmf/src/directives/displayqueries.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: contribs/gmf/src/directives/displayqueries.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>goog.provide('gmf.DisplayqueriesController');
goog.provide('gmf.displayqueriesDirective');

goog.require('gmf');
goog.require('ngeo.FeatureOverlay');
goog.require('ngeo.FeatureOverlayMgr');
goog.require('ol.Collection');
goog.require('ol.style.Circle');
goog.require('ol.style.Fill');
goog.require('ol.style.Stroke');
goog.require('ol.style.Style');


ngeoModule.value('gmfDisplayqueriesTemplateUrl',
    /**
     * @param {angular.JQLite} element Element.
     * @param {angular.Attributes} attrs Attributes.
     */
    function(element, attrs) {
      var templateUrl = attrs['gmfDisplayqueriesTemplateurl'];
      return templateUrl !== undefined ? templateUrl :
          gmf.baseTemplateUrl + '/displayqueries.html';
    });


/**
 * Provide a "gmf display queries" directive.
 *
 * This directive displays results of the ngeoQueryResult and shows related
 * features on the map using the ngeoFeatureOverlayMgr.
 *
 * You can override the default directive's template by setting the value
 * 'gmfDisplayqueriesTemplateUrl'.
 *
 * Features displayed on the map use a default style but you can override these
 * styles by passing ol.style.Style objects as attributes of this directive.
 *
 * @example
 * &lt;gmf-displayqueries
 *     gmf-displayqueries-featuresstyle="ctrl.styleForAllFeatures"
 *     gmf-displayqueries-selectedfeaturestyle="ctrl.styleForTheCurrentFeature">
 * &lt;/gmf-displayqueries>
 *
 * @htmlAttribute {ol.style.Style} gmf-displayqueries-featuresstyle A style
 *     object for all features from the result of the query.
 * @htmlAttribute {ol.style.Style} selectedfeaturestyle A style
 *     object for the current displayed feature.
 * @param {string} gmfDisplayqueriesTemplateUrl URL to a template.
 * @return {angular.Directive} Directive Definition Object.
 * @ngInject
 * @ngdoc directive
 * @ngname gmfDisplayqueries
 */
gmf.displayqueriesDirective = function(gmfDisplayqueriesTemplateUrl) {
  return {
    bindToController: true,
    controller: 'GmfDisplayqueriesController',
    controllerAs: 'ctrl',
    templateUrl: gmfDisplayqueriesTemplateUrl,
    replace: true,
    restrict: 'E',
    scope: {
      'featuresStyleFn': '&amp;gmfDisplayqueriesFeaturesstyle',
      'selectedFeatureStyleFn': '&amp;gmfDisplayqueriesSelectedfeaturestyle'
    }
  };
};


gmfModule.directive('gmfDisplayqueries', gmf.displayqueriesDirective);



/**
 * @param {angular.Scope} $scope Angular scope.
 * @param {Object} ngeoQueryResult ngeo query result FIXME.
 * @param {ngeo.FeatureOverlayMgr} ngeoFeatureOverlayMgr The ngeo feature
 *     overlay manager service.
 * @constructor
 * @export
 * @ngInject
 * @ngdoc Controller
 * @ngname GmfDisplayqueriesController
 */
gmf.DisplayqueriesController = function($scope, ngeoQueryResult,
    ngeoFeatureOverlayMgr) {

  /**
   * @type {Object} FIXME
   * @private
   */
  this.ngeoQueryResult_ = ngeoQueryResult;

  /**
   * @type {ol.Collection}
   * @private
   */
  this.features_ = new ol.Collection();

  var featureOverlay = ngeoFeatureOverlayMgr.getFeatureOverlay();
  var featuresStyle = this['featuresStyleFn']();
  if (goog.isDef(featuresStyle)) {
    goog.asserts.assertInstanceof(featuresStyle, ol.style.Style);
    featureOverlay.setStyle(featuresStyle);
  }
  featureOverlay.setFeatures(this.features_);

  /**
   * @type {ngeo.FeatureOverlay}
   * @private
   */
  this.selectedFeatureOverlay_ = ngeoFeatureOverlayMgr.getFeatureOverlay();

  var selectedFeatureStyle = this['selectedFeatureStyleFn']();
  if (goog.isDef(selectedFeatureStyle)) {
    goog.asserts.assertInstanceof(selectedFeatureStyle, ol.style.Style);
  } else {
    var fill = new ol.style.Fill({color: [255, 0, 0, 0.6]});
    var stroke = new ol.style.Stroke({color: [255, 0, 0, 1], width: 2});
    selectedFeatureStyle = new ol.style.Style({
      fill: fill,
      image: new ol.style.Circle({fill: fill, radius: 5, stroke: stroke}),
      stroke: stroke
    });
  }
  this.selectedFeatureOverlay_.setStyle(selectedFeatureStyle);


  /**
   * @type {boolean}
   * @export
   */
  this.open = false;

  /**
   * @type {Object}
   * @export
   */
  this.source = null;

  /**
   * @type {ol.Feature}
   * @export
   */
  this.feature = null;

  /**
   * @type {number}
   * @export
   */
  this.currentResult = 0;

  $scope.$watchCollection(
      function() {
        return ngeoQueryResult.sources;
      },
      angular.bind(this, function(newSources, oldSources) {
        if (newSources.length > 0 &amp;&amp; newSources !== oldSources) {
          this.show();
        }
      }));
};


/**
 * Remove current displayed results then get new results from the
 * ngeoQueryResult sevice. Display all results on the map and display,
 * highlight the first feature.
 * @export
 */
gmf.DisplayqueriesController.prototype.show = function() {
  this.clear();
  this.setCurrentResult_(0);
  if (this.source !== null) {
    this.collectFeatures_();
    this.highlightCurrentFeature_();
    this.open = true;
  }
};


/**
 * Select a source and a feature depending of the given position.
 * @param {number} position The index of the feature. If the position is bigger
 * than the length of the first source, get it in the next source. Etc.
 * @private
 */
gmf.DisplayqueriesController.prototype.setCurrentResult_ = function(position) {
  var i, source, features;
  var sources = this.ngeoQueryResult_.sources;
  this.currentResult = position;
  for (i = 0; i &lt; sources.length; i++) {
    source = sources[i];
    features = source.features;
    if (position >= features.length) {
      position -= features.length;
    } else {
      this.source = source;
      this.feature = source.features[position];
      break;
    }
  }
};


/**
 * Select the logical previous source and feature then highlight this feature on
 * the map.
 * @export
 */
gmf.DisplayqueriesController.prototype.previous = function() {
  var lastFeature = this.feature;
  var position = this.currentResult - 1;
  if (position &lt; 0) {
    position = this.getResultLength() - 1;
  }
  this.setCurrentResult_(position);
  this.highlightCurrentFeature_(lastFeature);
};


/**
 * Select the logical next source and feature then highlight this feature on
 * the map.
 * @export
 */
gmf.DisplayqueriesController.prototype.next = function() {
  var lastFeature = this.feature;
  var position = this.currentResult + 1;
  var positionMax = this.getResultLength() - 1;
  if (position > positionMax) {
    position = 0;
  }
  this.setCurrentResult_(position);
  this.highlightCurrentFeature_(lastFeature);
};


/**
 * Get the total count of features in the result of the query.
 * @return {number}
 * @export
 */
gmf.DisplayqueriesController.prototype.getResultLength = function() {
  var sources = this.ngeoQueryResult_.sources;
  var sourcesLength = sources.length;
  if (!goog.isDef(sourcesLength) || sourcesLength &lt;= 0) {
    return 0;
  }
  return sourcesLength + sources[sourcesLength - 1].features.length;
};


/**
 * Collect all features in the queryResult object.
 * @private
 */
gmf.DisplayqueriesController.prototype.collectFeatures_ = function() {
  var i, ii, features;
  var sources = this.ngeoQueryResult_.sources;
  this.features_.clear();
  for (i = 0; i &lt; sources.length; i++) {
    features = sources[i].features;
    for (ii = 0; ii &lt; features.length; ii++) {
      this.features_.push(features[ii]);
    }
  }
};


/**
 * Highlight the current displayed feature.
 * @param {ol.Feature=} opt_lastFeature last highlighted feature. Require if
 * it exists because it must be added to the 'non-selected' features collection.
 * @private
 */
gmf.DisplayqueriesController.prototype.highlightCurrentFeature_ = function(
    opt_lastFeature) {
  this.selectedFeatureOverlay_.clear();
  this.features_.remove(this.feature);
  this.selectedFeatureOverlay_.addFeature(this.feature);
  if (goog.isDef(opt_lastFeature)) {
    this.features_.push(opt_lastFeature);
  }
};


/**
 * Remove the current selected feature and source and remove all features
 * from the map.
 * @export
 */
gmf.DisplayqueriesController.prototype.close = function() {
  this.open = false;
  this.clear();
};


/**
 * Remove the current selected feature and source and remove all features
 * from the map.
 * @export
 */
gmf.DisplayqueriesController.prototype.clear = function() {
  this.feature = null;
  this.source = null;
  this.currentResult = 0;
  this.features_.clear();
  this.selectedFeatureOverlay_.clear();
};


gmfModule.controller('GmfDisplayqueriesController',
    gmf.DisplayqueriesController);
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h2>gmf</h2><h3>Directives</h3><ul><li><a href="gmf.authenticationDirective.html">authenticationDirective</a></li><li><a href="gmf.displayqueriesDirective.html">displayqueriesDirective</a></li><li><a href="gmf.layertreeDirective.html">layertreeDirective</a></li><li><a href="gmf.mapDirective.html">mapDirective</a></li><li><a href="gmf.mobileBackgroundLayerSelectorDirective.html">mobileBackgroundLayerSelectorDirective</a></li><li><a href="gmf.searchDirective.html">searchDirective</a></li><li><a href="gmf.themeselectorDirective.html">themeselectorDirective</a></li></ul><h3>Services</h3><ul><li><a href="gmf.Themes.html">Themes</a></li></ul><h3>Controllers</h3><ul><li><a href="gmf.AuthenticationController.html">AuthenticationController</a></li><li><a href="gmf.LayertreeController.html">LayertreeController</a></li><li><a href="gmf.MapController.html">MapController</a></li><li><a href="gmf.MobileBackgroundLayerSelectorController.html">MobileBackgroundLayerSelectorController</a></li><li><a href="gmf.SearchController.html">SearchController</a></li><li><a href="gmf.ThemeselectorController.html">ThemeselectorController</a></li></ul><h3>Classes</h3><ul><li><a href="gmf.AbstractDesktopController.html">AbstractDesktopController</a></li><li><a href="gmf.AbstractMobileController.html">AbstractMobileController</a></li><li><a href="gmf.Authentication.html">Authentication</a></li><li><a href="gmf.DisplayqueriesController.html">DisplayqueriesController</a></li></ul><h3>Types</h3><ul><li><a href="gmf.html#AuthenticationDefaultResponse">AuthenticationDefaultResponse</a></li><li><a href="gmf.html#AuthenticationFunctionalities">AuthenticationFunctionalities</a></li><li><a href="gmf.html#AuthenticationLoginResponse">AuthenticationLoginResponse</a></li><li><a href="gmf.html#ExportFeatures">ExportFeatures</a></li><li><a href="gmf.html#ThemesResponse">ThemesResponse</a></li><li><a href="gmf.html#User">User</a></li></ul><h3>Enumerations</h3><ul><li><a href="gmf.html#AuthenticationRouteSuffix">AuthenticationRouteSuffix</a></li><li><a href="gmf.html#ExportFormat">ExportFormat</a></li><li><a href="gmf.html#ThemesEventType">ThemesEventType</a></li></ul><h2>gmf.source</h2><h3>Classes</h3><ul><li><a href="gmf.source.AsitVD.html">AsitVD</a></li><li><a href="gmf.source.Swisstopo.html">Swisstopo</a></li></ul><h2>ngeo</h2><h3>Directives</h3><ul><li><a href="ngeo.btnDirective.html">btnDirective</a></li><li><a href="ngeo.btngroupDirective.html">btngroupDirective</a></li><li><a href="ngeo.controlDirective.html">controlDirective</a></li><li><a href="ngeo.desktopGeolocationDirective.html">desktopGeolocationDirective</a></li><li><a href="ngeo.filereaderDirective.html">filereaderDirective</a></li><li><a href="ngeo.layertreeDirective.html">layertreeDirective</a></li><li><a href="ngeo.mapDirective.html">mapDirective</a></li><li><a href="ngeo.mobileGeolocationDirective.html">mobileGeolocationDirective</a></li><li><a href="ngeo.modalDirective.html">modalDirective</a></li><li><a href="ngeo.popupDirective.html">popupDirective</a></li><li><a href="ngeo.profileDirective.html">profileDirective</a></li><li><a href="ngeo.recenterDirective.html">recenterDirective</a></li><li><a href="ngeo.resizemapDirective.html">resizemapDirective</a></li><li><a href="ngeo.scaleselectorDirective.html">scaleselectorDirective</a></li><li><a href="ngeo.searchDirective.html">searchDirective</a></li><li><a href="ngeo.sortableDirective.html">sortableDirective</a></li></ul><h3>Services</h3><ul><li><a href="ngeo.BackgroundLayerMgr.html">BackgroundLayerMgr</a></li><li><a href="ngeo.CreateGeoJSONBloodhound.html">CreateGeoJSONBloodhound</a></li><li><a href="ngeo.createPrintServiceFactory.html">createPrintServiceFactory</a></li><li><a href="ngeo.Debounce.html">Debounce</a></li><li><a href="ngeo.DecorateGeolocation.html">DecorateGeolocation</a></li><li><a href="ngeo.DecorateInteraction.html">DecorateInteraction</a></li><li><a href="ngeo.DecorateLayer.html">DecorateLayer</a></li><li><a href="ngeo.FeatureOverlayMgr.html">FeatureOverlayMgr</a></li><li><a href="ngeo.getBrowserLanguageFactory.html">getBrowserLanguageFactory</a></li><li><a href="ngeo.LayerHelper.html">LayerHelper</a></li><li><a href="ngeo.Location.html">Location</a></li><li><a href="ngeo.Popup.html">Popup</a></li><li><a href="ngeo.PrintUtils.html">PrintUtils</a></li><li><a href="ngeo.SyncArrays.html">SyncArrays</a></li><li><a href="ngeo.ToolActivateMgr.html">ToolActivateMgr</a></li></ul><h3>Controllers</h3><ul><li><a href="ngeo.BtnGroupController.html">BtnGroupController</a></li><li><a href="ngeo.DesktopGeolocationController.html">DesktopGeolocationController</a></li><li><a href="ngeo.LayertreeController.html">LayertreeController</a></li><li><a href="ngeo.MobileGeolocationController.html">MobileGeolocationController</a></li><li><a href="ngeo.ScaleselectorController.html">ScaleselectorController</a></li></ul><h3>Classes</h3><ul><li><a href="ngeo.BackgroundEvent.html">BackgroundEvent</a></li><li><a href="ngeo.FeatureOverlay.html">FeatureOverlay</a></li><li><a href="ngeo.MeasureEvent.html">MeasureEvent</a></li><li><a href="ngeo.Print.html">Print</a></li><li><a href="ngeo.profile.html">profile</a></li><li><a href="ngeo.StateManager.html">StateManager</a></li><li><a href="ngeo.ToolActivate.html">ToolActivate</a></li></ul><h3>Types</h3><ul><li><a href="ngeo.html#CreatePopup">CreatePopup</a></li><li><a href="ngeo.html#CreatePrint">CreatePrint</a></li><li><a href="ngeo.html#FeatureOverlayGroup">FeatureOverlayGroup</a></li><li><a href="ngeo.html#GetBrowserLanguage">GetBrowserLanguage</a></li><li><a href="ngeo.html#MockLocationProvider">MockLocationProvider</a></li><li><a href="ngeo.html#ScaleselectorOptions">ScaleselectorOptions</a></li><li><a href="ngeo.html#SortableOptions">SortableOptions</a></li></ul><h3>Enumerations</h3><ul><li><a href="ngeo.html#BackgroundEventType">BackgroundEventType</a></li><li><a href="ngeo.html#MeasureEventType">MeasureEventType</a></li><li><a href="ngeo.html#PrintStyleType">PrintStyleType</a></li></ul><h2>ngeo.format</h2><h3>Classes</h3><ul><li><a href="ngeo.format.FeatureHash.html">FeatureHash</a></li></ul><h3>Enumerations</h3><ul><li><a href="ngeo.format.html#FeatureHashStyleType">FeatureHashStyleType</a></li></ul><h2>ngeo.interaction</h2><h3>Classes</h3><ul><li><a href="ngeo.interaction.DrawAzimut.html">DrawAzimut</a></li><li><a href="ngeo.interaction.Measure.html">Measure</a></li><li><a href="ngeo.interaction.MeasureArea.html">MeasureArea</a></li><li><a href="ngeo.interaction.MeasureAzimut.html">MeasureAzimut</a></li><li><a href="ngeo.interaction.MeasureLength.html">MeasureLength</a></li></ul><h3>Types</h3><ul><li><a href="ngeo.interaction.html#MeasureBaseOptions">MeasureBaseOptions</a></li></ul><h2>ngeo.MeasureEvent</h2><h3>Events</h3><ul><li><a href="ngeo.MeasureEvent.html#event:measureend">measureend</a></li></ul><h2>ngeox</h2><h3>Interfaces</h3><ul><li><a href="ngeox.BackgroundEvent.html">BackgroundEvent</a></li><li><a href="ngeox.MeasureEvent.html">MeasureEvent</a></li></ul><h3>Types</h3><ul><li><a href="ngeox.html#DesktopGeolocationDirectiveOptions">DesktopGeolocationDirectiveOptions</a></li><li><a href="ngeox.html#MobileGeolocationDirectiveOptions">MobileGeolocationDirectiveOptions</a></li><li><a href="ngeox.html#SearchDirectiveListeners">SearchDirectiveListeners</a></li></ul><h2>gmfx</h2><h3>Types</h3><ul><li><a href="gmfx.html#Config">Config</a></li><li><a href="gmfx.html#SearchDirectiveDatasource">SearchDirectiveDatasource</a></li><li><a href="gmfx.html#ServiceUrls">ServiceUrls</a></li></ul><h2>gmfx.source</h2><h3>Types</h3><ul><li><a href="gmfx.source.html#AsitVDOptions">AsitVDOptions</a></li><li><a href="gmfx.source.html#SwisstopoOptions">SwisstopoOptions</a></li></ul><h2>ngeox.format</h2><h3>Types</h3><ul><li><a href="ngeox.format.html#FeatureHashOptions">FeatureHashOptions</a></li></ul><h2>ngeox.interaction</h2><h3>Types</h3><ul><li><a href="ngeox.interaction.html#MeasureOptions">MeasureOptions</a></li></ul><h2>ngeox.profile</h2><h3>Types</h3><ul><li><a href="ngeox.profile.html#ElevationExtractor">ElevationExtractor</a></li><li><a href="ngeox.profile.html#PoiExtractor">PoiExtractor</a></li><li><a href="ngeox.profile.html#ProfileFormatter">ProfileFormatter</a></li><li><a href="ngeox.profile.html#ProfileOptions">ProfileOptions</a></li></ul><h3>Global</h3><ul><li><a href="global.html#gmfx">gmfx</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.0</a>
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
